USE hash;

slow_test_list:=["demos\\ackermann.mnh",
                 "demos\\dice7fromDice5.mnh",
                 "demos\\digitSquareSum.mnh",
                 "demos\\hailstone.mnh",
                 "demos\\hofstadterConway.mnh",
                 "demos\\ludic.mnh",
                 "demos\\monteCarloPi.mnh",
                 "demos\\pythagoras.mnh",
                 "demos\\selfRefSeq.mnh",
                 "demos\\vampire.mnh",
                 "demos\\ulam.mnh",
                 "demos\\unbiasedRandom.mnh",
                 "demos\\weasel.mnh",
                 "demos\\wordCount.mnh"];

mutable
test_list:=["regTest\\opTest.mnh",
            "regTest\\hash.mnh",
            "packages\\basic.mnh",
            "packages\\bool.mnh",
            "packages\\combinatorics.mnh",
            "packages\\primes.mnh",
            "demos\\12_statements.mnh",
            "demos\\24.mnh",
            "demos\\99bottles.mnh",
            "demos\\anagram.mnh",
            "demos\\concatInts.mnh",
            "demos\\fibonacci.mnh",
            "demos\\fibonacciWord.mnh",
            "demos\\fractran.mnh",
            "demos\\hamming.mnh",
            "demos\\huffmann.mnh",
            "demos\\josephus.mnh",
            "demos\\lastSundays.mnh",
            "demos\\magicSquare.mnh",
            "demos\\pascal.mnh",
            "demos\\pernicousNumbers.mnh",
            "demos\\quine.mnh",
            "demos\\quine2.mnh",
            "demos\\range_extract_expand.mnh",
            "demos\\rk4.mnh",
            "demos\\roman.mnh",
            "demos\\root.mnh",
            "demos\\setConsolidation.mnh",
            "demos\\shannonEntropy.mnh",
            "demos\\sierpinski.mnh",
            "demos\\variadic.mnh",
            "demos\\y.mnh",
            "demos\\zeckendorf.mnh"];

test_with_output_list:=[["demos\\barnsleyFern.mnh","demos\\barnsleyFern.png"],
                        ["demos\\fibMaze.mnh"     ,"demos\\fibMaze.png"],
                        ["demos\\kochCurve.mnh"   ,"demos\\kochCurve.png"]];

includeSlowTests->head(test_list:=unique(test_list| slow_test_list),0);
                        
FMT_STRING:="%X" & max(length(test_list)) & "% %####0.00%sec ";

testDirectory:=replace(splitFileName(myPath)%"relative",
                       splitFileName(myPath)%"filename","");
mutable testsFailed:="";
synchronized addFailedTest(scriptName)->copy(testsFailed:=testsFailed&format("\nkdiff %X% %X%",expectedResultName(scriptName),lastResultName(scriptName)),1,0);

expectedResultName  (scriptname)->testDirectory&replace(splitFileName(scriptname)%"filename"&"#",".mnh#",".expected");
lastResultName      (scriptname)->testDirectory&replace(splitFileName(scriptname)%"filename"&"#",".mnh#",".last");
expectedResultExists(scriptname)->fileExists(expectedResultName(scriptname));
expectedResult      (scriptname)->fileLines (expectedResultName(scriptname));

storeResult(filename,data)-> writeFileLines(filename,data) ? void : void;

runScript(executor,scriptName,outputFileName)->(outputFileName<>'' ? (deleteFile(outputFileName) ? void : void) : void)|
                                               print(checkResult(scriptName,systime,exec(executor,["-det",scriptName]) | (outputFileName="" ? [] : fileHash(outputFileName)),systime));
checkResult(scriptName,t0,result,t1)->format(FMT_STRING,scriptName,(t1-t0)*24*60*60)& (
  expectedResultExists(scriptName) ? (expectedResult(scriptName)==result ? "o.k."
                                                                         :  "Results differ!"&addFailedTest(scriptName)&storeResult(lastResultName(scriptName),result))
                                   : "No reference result found. Storing "&storeResult(expectedResultName(scriptName),result));

reportStart(executor)->print('-----------------------------------------------------\n',
                             'Starting test runs with executable '&executor,
                             '\n-----------------------------------------------------');
matchesAny(filter,input)->each(f,filter,or,pos(f,input)>=0);

main(executor,'quick'   )->reportStart(executor) and pEach(test,test_list,                                  runScript(executor,test  ,""    )        ) and print(testsFailed);
main(executor           )->includeSlowTests | 
                           reportStart(executor) and each(test,test_list,                                   runScript(executor,test  ,""    )        )
                                     and each(test,test_with_output_list,                                   runScript(executor,test%0,test%1)        ) and print(testsFailed);
main(executor,filter,...)->includeSlowTests | 
                           reportStart(executor) and each(test,test_list,matchesAny(tail($params),test  ) ? runScript(executor,test  ,""    )  : void)
                                     and each(test,test_with_output_list,matchesAny(tail($params),test%0) ? runScript(executor,test%0,test%1)  : void) and print(testsFailed);
main->main(executor);
